<!DOCTYPE html>
<html>
<head>
    <title>Debug Question 213 Missing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .debug-output { background: #f0f0f0; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        .success { background: #d4edda; border-color: #28a745; }
        .warning { background: #fff3cd; border-color: #ffc107; }
        .error { background: #f8d7da; border-color: #dc3545; }
        button { margin: 5px; padding: 10px 20px; }
    </style>
</head>
<body>
    <h1>üîç Debug: Question 213 Missing from Student Page</h1>
    
    <div class="section">
        <h2>üìã Known Facts</h2>
        <ul>
            <li>‚úÖ Question 213 exists in questions-b.json and q-compiled-b.json</li>
            <li>‚úÖ Redis contains performance data: user_question:b58f18fd-133f-433b-9279-f2b45b42048b:213</li>
            <li>‚úÖ Data shows: 2 attempts, 2 correct, 100% success rate, B1 difficulty, fill-in-the-blank</li>
            <li>‚ùì Question 213 not appearing in student page Question Performance section</li>
        </ul>
    </div>
    
    <div class="section">
        <h2>üîç Diagnostic Steps</h2>
        <button onclick="checkUUID()">1. Check Browser UUID</button>
        <button onclick="checkWebSocket()">2. Check WebSocket Connection</button>
        <button onclick="requestPerformanceData()">3. Request Performance Data</button>
        <button onclick="checkQuestionBank()">4. Check Question Bank</button>
        <div id="debugOutput" class="debug-output"></div>
    </div>
    
    <div class="section">
        <h2>üîß Manual Test</h2>
        <button onclick="simulateResponse()">Simulate Question 213 Response</button>
        <div id="simulationOutput" class="debug-output"></div>
    </div>

    <script>
        function log(message, outputId = 'debugOutput') {
            const output = document.getElementById(outputId);
            output.textContent += new Date().toISOString() + ' - ' + message + '\n';
        }
        
        function clearOutput(outputId = 'debugOutput') {
            document.getElementById(outputId).textContent = '';
        }
        
        // Get UUID from cookie (same logic as student.html)
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        function checkUUID() {
            clearOutput();
            const uuid = getCookie('french_listening_uuid');
            log('üîç Checking browser UUID...');
            log('Browser UUID: ' + (uuid || 'NOT FOUND'));
            log('Expected UUID: b58f18fd-133f-433b-9279-f2b45b42048b');
            log('Match: ' + (uuid === 'b58f18fd-133f-433b-9279-f2b45b42048b' ? '‚úÖ YES' : '‚ùå NO'));
            
            if (!uuid) {
                log('‚ö†Ô∏è No UUID found in cookies. This could be the problem!');
                log('üí° Try opening the main app first to set the UUID cookie.');
            } else if (uuid !== 'b58f18fd-133f-433b-9279-f2b45b42048b') {
                log('‚ö†Ô∏è UUID mismatch! The browser is using a different UUID than Redis data.');
                log('üí° Redis data exists for: b58f18fd-133f-433b-9279-f2b45b42048b');
                log('üí° Browser is using: ' + uuid);
            }
        }
        
        function checkWebSocket() {
            clearOutput();
            log('üîç Checking WebSocket connection...');
            
            // Try to connect like student.html does
            try {
                const testSocket = new WebSocket('ws://localhost:8080');
                testSocket.onopen = () => {
                    log('‚úÖ WebSocket connection successful');
                    testSocket.close();
                };
                testSocket.onerror = (error) => {
                    log('‚ùå WebSocket connection failed: ' + error);
                };
                testSocket.onclose = () => {
                    log('üîå WebSocket connection closed');
                };
            } catch (error) {
                log('‚ùå WebSocket error: ' + error.message);
                log('üí° Make sure Redis cache server is running: ./start-cache-server.sh');
            }
        }
        
        function requestPerformanceData() {
            clearOutput();
            log('üîç Testing performance data request...');
            
            const uuid = getCookie('french_listening_uuid');
            if (!uuid) {
                log('‚ùå No UUID found. Cannot test performance data request.');
                return;
            }
            
            const socket = new WebSocket('ws://localhost:8080');
            socket.onopen = () => {
                log('‚úÖ Connected to WebSocket server');
                log('üì§ Sending performance data request...');
                socket.send(JSON.stringify({ 
                    action: 'get_user_question_performance', 
                    uuid: uuid 
                }));
            };
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log('üì• Received response: ' + data.type);
                
                if (data.type === 'user_question_performance_result') {
                    const performances = data.questionPerformances || [];
                    log('üìä Total questions in response: ' + performances.length);
                    
                    const question213 = performances.find(p => p.questionId === 213);
                    if (question213) {
                        log('‚úÖ Question 213 FOUND in response!');
                        log('üìã Data: ' + JSON.stringify(question213, null, 2));
                    } else {
                        log('‚ùå Question 213 NOT FOUND in response');
                        log('üìã Available question IDs: [' + performances.map(p => p.questionId).sort((a,b) => a-b).join(', ') + ']');
                    }
                } else {
                    log('‚ö†Ô∏è Unexpected response type: ' + data.type);
                }
                socket.close();
            };
            
            socket.onerror = (error) => {
                log('‚ùå WebSocket error: ' + error);
            };
        }
        
        function checkQuestionBank() {
            clearOutput();
            log('üîç Checking question bank loading...');
            
            // Test loading question bank like the main app does
            fetch('questions/q-compiled-b.json')
                .then(response => response.json())
                .then(data => {
                    const questions = data.questions || data;
                    const question213 = questions.find(q => q.id === 213);
                    
                    if (question213) {
                        log('‚úÖ Question 213 found in q-compiled-b.json');
                        log('üìã Question: ' + question213.question);
                        log('üìã Type: ' + question213.questionType);
                        log('üìã Difficulty: ' + question213.difficulty);
                    } else {
                        log('‚ùå Question 213 NOT found in q-compiled-b.json');
                    }
                })
                .catch(error => {
                    log('‚ùå Error loading question bank: ' + error.message);
                });
        }
        
        function simulateResponse() {
            clearOutput('simulationOutput');
            log('üß™ Simulating question 213 in performance table...', 'simulationOutput');
            
            // Create mock data including question 213
            const mockData = [
                {
                    questionId: 212,
                    difficulty: 'B1',
                    questionType: 'comprehension',
                    attempts: 3,
                    successRate: 67,
                    lastAttempted: Date.now() - 86400000
                },
                {
                    questionId: 213,
                    difficulty: 'B1',
                    questionType: 'fill-in-the-blank',
                    attempts: 2,
                    successRate: 100,
                    lastAttempted: Date.now() - 3600000
                },
                {
                    questionId: 214,
                    difficulty: 'B1',
                    questionType: 'listening',
                    attempts: 1,
                    successRate: 100,
                    lastAttempted: Date.now() - 1800000
                }
            ];
            
            // Simulate the renderQuestionPerformanceTable function
            let html = `
                <table>
                    <tr>
                        <th>Question ID</th>
                        <th>Difficulty</th>
                        <th>Type</th>
                        <th>Attempts</th>
                        <th>Success Rate</th>
                        <th>Last Attempted</th>
                    </tr>
            `;
            
            for (const performance of mockData) {
                const successRateClass = 
                    performance.successRate >= 80 ? 'success-excellent' :
                    performance.successRate >= 60 ? 'success-good' :
                    performance.successRate >= 40 ? 'success-okay' : 'success-poor';
                
                const lastAttemptedDate = new Date(performance.lastAttempted);
                
                html += `
                    <tr ${performance.questionId === 213 ? 'style="background: #fff3cd;"' : ''}>
                        <td>${performance.questionId}</td>
                        <td>${performance.difficulty}</td>
                        <td>${performance.questionType}</td>
                        <td>${performance.attempts}</td>
                        <td class="${successRateClass}">${performance.successRate}%</td>
                        <td>${lastAttemptedDate.toLocaleDateString()}</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            
            // Create a container to show the simulated table
            const container = document.createElement('div');
            container.innerHTML = html;
            container.style.marginTop = '10px';
            document.getElementById('simulationOutput').appendChild(container);
            
            log('‚úÖ Simulation complete - Question 213 highlighted in yellow', 'simulationOutput');
            log('üìã This shows how question 213 should appear in the table', 'simulationOutput');
        }
    </script>
</body>
</html>