<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 60px 50px;
            max-width: 900px;
            width: 100%;
            text-align: center;
            margin: 40px 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        th, td {
            padding: 18px 15px;
            border-bottom: 1px solid #e9ecef;
            text-align: center;
        }
        th {
            background: #f8f9fa;
            color: #667eea;
            font-size: 1.1em;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
            transition: background-color 0.2s;
        }
        th:hover {
            background: #e9ecef;
        }
        th.sortable::after {
            content: "‚ÜïÔ∏è";
            position: absolute;
            right: 8px;
            opacity: 0.5;
            font-size: 0.8em;
        }
        th.sort-asc::after {
            content: "‚Üë";
            opacity: 1;
            color: #667eea;
        }
        th.sort-desc::after {
            content: "‚Üì";
            opacity: 1;
            color: #667eea;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .count {
            font-weight: bold;
            color: #764ba2;
        }
        .success-rate {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            text-align: center;
        }
        .success-excellent { background: #28a745; }
        .success-good { background: #20c997; }
        .success-okay { background: #fd7e14; }
        .success-poor { background: #dc3545; }
        .difficulty-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        .diff-A1 { background: #28a745; }
        .diff-A2 { background: #20c997; }
        .diff-B1 { background: #fd7e14; }
        .diff-B2 { background: #e83e8c; }
        .diff-C1 { background: #6f42c1; }
        .diff-C2 { background: #dc3545; }
        .refresh-btn, .clear-btn {
            margin: 25px 15px 0;
            padding: 14px 28px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover, .clear-btn:hover {
            opacity: 0.9;
        }
        .empty {
            color: #888;
            margin: 50px 0;
            font-size: 1.1em;
        }
        .back-link {
            display: inline-block;
            margin-top: 40px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            font-size: 1.15em;
            transition: color 0.2s;
        }
        .back-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        .question-link {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }
        .question-link:hover {
            color: #764ba2;
            background: #f0f3ff;
            transform: translateX(2px);
            text-decoration: none;
        }
        .hamburger-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .hamburger-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            padding: 0;
            position: relative;
        }
        .hamburger-btn:focus {
            outline: 2px solid #764ba2;
        }
        .hamburger-btn .bar {
            display: block;
            width: 22px;
            height: 3px;
            margin: 3px 0;
            background: #fff;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .menu-dropdown {
            display: none;
            position: absolute;
            top: 48px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.18);
            min-width: 180px;
            padding: 10px 0;
            flex-direction: column;
            z-index: 200;
            animation: fadeIn 0.2s;
        }
        .menu-dropdown a {
            display: block;
            padding: 12px 24px;
            color: #333;
            text-decoration: none;
            font-size: 1.05em;
            transition: background 0.15s, color 0.15s;
        }
        .menu-dropdown a:hover {
            background: #f3f4fa;
            color: #764ba2;
        }
        .hamburger-menu.open .menu-dropdown {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Collapsible container styles */
        .collapsible-container {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .collapsible-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .collapsible-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .collapsible-title {
            font-size: 1.4em;
            color: #333;
            font-weight: 600;
            margin: 0;
        }
        
        .collapsible-toggle {
            font-size: 1.2em;
            color: #667eea;
            transition: transform 0.3s ease;
        }
        
        .collapsible-container.collapsed .collapsible-toggle {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            padding: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .collapsible-container.collapsed .collapsible-content {
            max-height: 0;
            padding: 0 20px;
            opacity: 0;
        }
        
        /* CEFR Level Progress Styles */
        .level-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }
        
        .level-card.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #fff 100%);
        }
        
        .level-card.completed:hover {
            border-color: #20c997;
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.25);
        }
        
        .level-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 8px;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            min-width: 80px;
        }
        
        .level-A1 { background: #28a745; }
        .level-A2 { background: #20c997; }
        .level-B1 { background: #fd7e14; }
        .level-B2 { background: #e83e8c; }
        .level-C1 { background: #6f42c1; }
        .level-C2 { background: #dc3545; }
        
        .level-stats {
            margin: 15px 0;
            font-size: 1.1em;
            color: #495057;
        }
        
        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }
        
        .progress-bar.completed {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .level-details {
            font-size: 0.95em;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .mastery-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ffd700;
            color: #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        
        .overall-progress {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        
        .overall-progress h3 {
            margin: 0 0 10px;
            font-size: 1.4em;
        }
        
        .overall-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .overall-stat {
            text-align: center;
        }
        
        .overall-stat .number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }
        
        .overall-stat .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* Responsive spacing adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 40px 30px;
                margin: 20px 15px;
                max-width: 100%;
            }
            
            h1 {
                font-size: 1.8em;
                margin-bottom: 25px;
            }
            
            h2 {
                font-size: 1.2em !important;
                margin: 30px 0 15px !important;
            }
            
            th, td {
                padding: 14px 10px;
                font-size: 0.9em;
            }
            
            .refresh-btn, .clear-btn {
                display: block;
                width: 100%;
                margin: 15px 0;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .level-progress-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .level-card {
                padding: 15px;
            }
            
            .level-title {
                font-size: 1.5em;
            }
            
            .overall-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .overall-stat .number {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="hamburger-menu" id="hamburgerMenu">
        <button class="hamburger-btn" id="hamburgerBtn" title="Menu" aria-label="Open menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>
        <div class="menu-dropdown" id="menuDropdown">
            <a href="student.html">üë§ Student Dashboard</a>
            <a href="planning.html">üóÇÔ∏è Planning & Management</a>
        </div>
    </div>
    <div class="container">
        <h1>üë§ Student Dashboard</h1>
        <div id="userIdDisplay" style="margin-bottom:35px; color:#764ba2; font-size:1.15em; word-break:break-all;"></div>
        
        <!-- CEFR Level Progress Section -->
        <div class="collapsible-container" id="levelProgressCollapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('levelProgressCollapsible')">
                <h2 class="collapsible-title">üéØ CEFR Level Progress</h2>
                <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <div class="overall-progress" id="overallProgressSummary" style="display: none;">
                    <h3>üèÜ Overall Progress Summary</h3>
                    <div class="overall-stats">
                        <div class="overall-stat">
                            <span class="number" id="totalLevelsCompleted">0</span>
                            <span class="label">Levels Mastered</span>
                        </div>
                        <div class="overall-stat">
                            <span class="number" id="totalQuestionsCompleted">0</span>
                            <span class="label">Questions Mastered</span>
                        </div>
                        <div class="overall-stat">
                            <span class="number" id="overallProgressPercent">0%</span>
                            <span class="label">Overall Progress</span>
                        </div>
                    </div>
                </div>
                <div class="level-progress-grid" id="levelProgressGrid">
                    <!-- Level cards will be populated by JavaScript -->
                </div>
                <button class="refresh-btn" onclick="fetchLevelProgress()">üîÑ Refresh Progress</button>
            </div>
        </div>
        
        <!-- Per-Question Success Rate Section -->
        <div class="collapsible-container" id="performanceCollapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('performanceCollapsible')">
                <h2 class="collapsible-title">üìä Question Performance</h2>
                <span class="collapsible-toggle">‚ñº</span>
            </div>
            <div class="collapsible-content">
                <button class="refresh-btn" onclick="fetchQuestionPerformance()">üîÑ Refresh Performance</button>
                <button class="clear-btn" onclick="clearQuestionPerformance()">üóëÔ∏è Clear Performance</button>
                <div id="questionPerformanceContainer"></div>
            </div>
        </div>
        
        <a href="french_listening_app.html" class="back-link">‚Üê Back to Main Page</a>
    </div>
    <script src="function.js"></script>
    <script>
        // Display user UUID from cookie (must be before any use)
        const userUUID = getCookie('french_listening_uuid');
        document.getElementById('userIdDisplay').innerHTML = userUUID ? `<strong>User ID:</strong> <span style='font-family:monospace;'>${userUUID}</span>` : '<span style="color:#888">User ID not found</span>';
        let cacheSocket = null;
        function connectSocket() {
            cacheSocket = new WebSocket('ws://localhost:8080');
            cacheSocket.onopen = () => {
                fetchQuestionPerformance();
                fetchLevelProgress();
            };
            cacheSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'user_question_performance_result') {
                    renderQuestionPerformanceTable(data.questionPerformances);
                    calculateAndRenderLevelProgress(data.questionPerformances);
                }
            };
            cacheSocket.onclose = () => {
                setTimeout(connectSocket, 3000);
            };
        }
        connectSocket();

        function fetchQuestionPerformance() {
            if (cacheSocket && cacheSocket.readyState === WebSocket.OPEN && userUUID) {
                cacheSocket.send(JSON.stringify({ action: 'get_user_question_performance', uuid: userUUID }));
            }
        }

        function clearQuestionPerformance() {
            if (cacheSocket && cacheSocket.readyState === WebSocket.OPEN && userUUID) {
                if (confirm('Clear all question performance stats? This cannot be undone.')) {
                    // Note: This would need a backend implementation to clear user question stats
                    alert('Question performance clearing not yet implemented in backend');
                }
            }
        }

        function renderQuestionPerformanceTable(questionPerformances) {
            const container = document.getElementById('questionPerformanceContainer');
            
            if (!questionPerformances || questionPerformances.length === 0) {
                container.innerHTML = '<div class="empty">No questions attempted yet! Start practicing to see your progress! üìö</div>';
                return;
            }

            // Sort by question ID
            questionPerformances.sort((a, b) => a.questionId - b.questionId);

            let html = `
                <table id="performanceTable">
                    <tr>
                        <th class="sortable" data-sort="questionId" data-type="number">Question ID</th>
                        <th class="sortable" data-sort="difficulty" data-type="difficulty">Difficulty</th>
                        <th class="sortable" data-sort="questionType" data-type="string">Type</th>
                        <th class="sortable" data-sort="attempts" data-type="number">Attempts</th>
                        <th class="sortable" data-sort="successRate" data-type="number">Success Rate</th>
                        <th class="sortable" data-sort="lastAttempted" data-type="date">Last Attempted</th>
                    </tr>
            `;

            for (const performance of questionPerformances) {
                const successRateClass = 
                    performance.successRate >= 80 ? 'success-excellent' :
                    performance.successRate >= 60 ? 'success-good' :
                    performance.successRate >= 40 ? 'success-okay' : 'success-poor';
                
                const difficultyClass = `diff-${performance.difficulty}`;
                const typeIcon = performance.questionType === 'listening' ? 'üëÇ' : 
                                performance.questionType === 'fill-in-the-blank' ? '‚úèÔ∏è' : 'üìñ';
                
                const lastAttempted = new Date(performance.lastAttempted).toLocaleDateString();

                html += `
                    <tr>
                        <td><a href="french_listening_app.html?start=${performance.questionId}" class="question-link" title="Start quiz with question ${performance.questionId}"><strong>Q${performance.questionId} üöÄ</strong></a></td>
                        <td><span class="difficulty-badge ${difficultyClass}">${performance.difficulty}</span></td>
                        <td>${typeIcon} ${performance.questionType}</td>
                        <td class="count">${performance.attempts}</td>
                        <td><span class="success-rate ${successRateClass}">${performance.successRate}%</span></td>
                        <td style="font-size: 0.9em; color: #666;">${lastAttempted}</td>
                    </tr>
                `;
            }

            html += '</table>';
            
            // Add summary stats
            const totalAttempts = questionPerformances.reduce((sum, p) => sum + p.attempts, 0);
            const totalCorrect = questionPerformances.reduce((sum, p) => sum + (p.attempts * p.successRate / 100), 0);
            const overallSuccessRate = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <strong>Overall Performance:</strong> 
                    ${questionPerformances.length} questions attempted ‚Ä¢ 
                    ${totalAttempts} total attempts ‚Ä¢ 
                    <span class="success-rate ${overallSuccessRate >= 80 ? 'success-excellent' : overallSuccessRate >= 60 ? 'success-good' : overallSuccessRate >= 40 ? 'success-okay' : 'success-poor'}">${overallSuccessRate}% success rate</span>
                </div>
            `;

            container.innerHTML = html;
            
            // Add sorting functionality
            addTableSorting(questionPerformances);
        }

        // Global variables for sorting state
        let currentSort = { column: null, direction: 'asc' };
        let currentData = [];

        function addTableSorting(data) {
            currentData = data;
            const table = document.getElementById('performanceTable');
            const headers = table.querySelectorAll('th.sortable');
            
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortColumn = header.dataset.sort;
                    const sortType = header.dataset.type;
                    
                    // Update sort direction
                    if (currentSort.column === sortColumn) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = sortColumn;
                        currentSort.direction = 'asc';
                    }
                    
                    // Remove sort classes from all headers
                    headers.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    // Add sort class to current header
                    header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    
                    // Sort and re-render table
                    const sortedData = sortData(currentData, sortColumn, sortType, currentSort.direction);
                    renderSortedTable(sortedData);
                });
            });
        }

        function sortData(data, column, type, direction) {
            const sortedData = [...data].sort((a, b) => {
                let aVal, bVal;
                
                switch(type) {
                    case 'number':
                        aVal = a[column];
                        bVal = b[column];
                        break;
                    case 'string':
                        aVal = a[column].toLowerCase();
                        bVal = b[column].toLowerCase();
                        break;
                    case 'date':
                        aVal = new Date(a[column]);
                        bVal = new Date(b[column]);
                        break;
                    case 'difficulty':
                        const difficultyOrder = { 'A1': 1, 'A2': 2, 'B1': 3, 'B2': 4, 'C1': 5, 'C2': 6 };
                        aVal = difficultyOrder[a[column]] || 0;
                        bVal = difficultyOrder[b[column]] || 0;
                        break;
                    default:
                        aVal = a[column];
                        bVal = b[column];
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sortedData;
        }

        function renderSortedTable(questionPerformances) {
            const container = document.getElementById('questionPerformanceContainer');
            
            let html = `
                <table id="performanceTable">
                    <tr>
                        <th class="sortable" data-sort="questionId" data-type="number">Question ID</th>
                        <th class="sortable" data-sort="difficulty" data-type="difficulty">Difficulty</th>
                        <th class="sortable" data-sort="questionType" data-type="string">Type</th>
                        <th class="sortable" data-sort="attempts" data-type="number">Attempts</th>
                        <th class="sortable" data-sort="successRate" data-type="number">Success Rate</th>
                        <th class="sortable" data-sort="lastAttempted" data-type="date">Last Attempted</th>
                    </tr>
            `;

            for (const performance of questionPerformances) {
                const successRateClass = 
                    performance.successRate >= 80 ? 'success-excellent' :
                    performance.successRate >= 60 ? 'success-good' :
                    performance.successRate >= 40 ? 'success-okay' : 'success-poor';
                
                const difficultyClass = `diff-${performance.difficulty}`;
                const typeIcon = performance.questionType === 'listening' ? 'üëÇ' : 
                                performance.questionType === 'fill-in-the-blank' ? '‚úèÔ∏è' : 'üìñ';
                
                const lastAttempted = new Date(performance.lastAttempted).toLocaleDateString();

                html += `
                    <tr>
                        <td><a href="french_listening_app.html?start=${performance.questionId}" class="question-link" title="Start quiz with question ${performance.questionId}"><strong>Q${performance.questionId} üöÄ</strong></a></td>
                        <td><span class="difficulty-badge ${difficultyClass}">${performance.difficulty}</span></td>
                        <td>${typeIcon} ${performance.questionType}</td>
                        <td class="count">${performance.attempts}</td>
                        <td><span class="success-rate ${successRateClass}">${performance.successRate}%</span></td>
                        <td style="font-size: 0.9em; color: #666;">${lastAttempted}</td>
                    </tr>
                `;
            }

            html += '</table>';
            
            // Add summary stats
            const totalAttempts = questionPerformances.reduce((sum, p) => sum + p.attempts, 0);
            const totalCorrect = questionPerformances.reduce((sum, p) => sum + (p.attempts * p.successRate / 100), 0);
            const overallSuccessRate = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <strong>Overall Performance:</strong> 
                    ${questionPerformances.length} questions attempted ‚Ä¢ 
                    ${totalAttempts} total attempts ‚Ä¢ 
                    <span class="success-rate ${overallSuccessRate >= 80 ? 'success-excellent' : overallSuccessRate >= 60 ? 'success-good' : overallSuccessRate >= 40 ? 'success-okay' : 'success-poor'}">${overallSuccessRate}% success rate</span>
                </div>
            `;

            container.innerHTML = html;
            
            // Re-add sorting functionality and restore sort state
            addTableSorting(questionPerformances);
            
            // Restore current sort indicator
            if (currentSort.column) {
                const table = document.getElementById('performanceTable');
                const header = table.querySelector(`th[data-sort="${currentSort.column}"]`);
                if (header) {
                    header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
        }
        // Global variables for all questions data
        let allQuestionsData = {};

        // Fetch level progress - loads all question data to calculate progress
        async function fetchLevelProgress() {
            try {
                // Use the centralized question loader from function.js
                const result = await loadQuestionBank({
                    useCompiled: true,
                    enableLogging: true,
                    logLevel: 2
                });

                if (!result.success) {
                    throw new Error(result.error || 'Failed to load questions');
                }

                // Combine all questions and organize by difficulty level
                const allQuestions = result.questions;
                allQuestionsData = {
                    'A1': allQuestions.filter(q => q.difficulty === 'A1'),
                    'A2': allQuestions.filter(q => q.difficulty === 'A2'),
                    'B1': allQuestions.filter(q => q.difficulty === 'B1'),
                    'B2': allQuestions.filter(q => q.difficulty === 'B2'),
                    'C1': allQuestions.filter(q => q.difficulty === 'C1'),
                    'C2': allQuestions.filter(q => q.difficulty === 'C2')
                };

                // Fetch user performance data
                if (cacheSocket && cacheSocket.readyState === WebSocket.OPEN && userUUID) {
                    cacheSocket.send(JSON.stringify({ action: 'get_user_question_performance', uuid: userUUID }));
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('levelProgressGrid').innerHTML = '<div class="empty">Error loading question data</div>';
            }
        }

        // Calculate and render level progress based on user performance
        function calculateAndRenderLevelProgress(questionPerformances) {
            if (!allQuestionsData || Object.keys(allQuestionsData).length === 0) {
                return; // Questions data not loaded yet
            }

            const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const levelProgress = {};
            
            // Calculate progress for each level
            levels.forEach(level => {
                const questionsInLevel = allQuestionsData[level] || [];
                const totalQuestions = questionsInLevel.length;
                
                // Find user performance for questions in this level
                const masteredQuestions = questionsInLevel.filter(question => {
                    const performance = questionPerformances.find(p => p.questionId === question.id);
                    return performance && performance.successRate >= 70; // 70% threshold for mastery
                }).length;

                levelProgress[level] = {
                    total: totalQuestions,
                    mastered: masteredQuestions,
                    percentage: totalQuestions > 0 ? Math.round((masteredQuestions / totalQuestions) * 100) : 0,
                    isCompleted: totalQuestions > 0 && masteredQuestions === totalQuestions
                };
            });

            renderLevelProgressCards(levelProgress);
            renderOverallProgressSummary(levelProgress);
        }

        function renderLevelProgressCards(levelProgress) {
            const grid = document.getElementById('levelProgressGrid');
            const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            
            const levelDescriptions = {
                'A1': 'Beginner',
                'A2': 'Elementary', 
                'B1': 'Intermediate',
                'B2': 'Upper-Intermediate',
                'C1': 'Advanced',
                'C2': 'Proficiency'
            };

            let html = '';
            
            levels.forEach(level => {
                const progress = levelProgress[level];
                const progressPercentage = progress.percentage;
                const masteryBadge = progress.isCompleted ? '<div class="mastery-badge">üèÜ</div>' : '';
                const completedClass = progress.isCompleted ? 'completed' : '';
                const progressBarClass = progress.isCompleted ? 'completed' : '';

                // Find the best question to start with for this level
                const nextQuestionId = findBestQuestionForLevel(level);
                const clickAction = nextQuestionId ? `launchQuizWithLevel('${level}', ${nextQuestionId})` : '';
                const clickableClass = nextQuestionId ? 'clickable' : '';
                const clickHint = nextQuestionId ? `<div style="font-size: 0.9em; color: #667eea; margin-top: 8px; font-weight: 500;">üöÄ Click to practice!</div>` : '';

                html += `
                    <div class="level-card ${completedClass} ${clickableClass}" ${clickAction ? `onclick="${clickAction}"` : ''} ${clickAction ? `title="Click to start practicing ${level} level questions"` : ''}>
                        ${masteryBadge}
                        <div class="level-title level-${level}">${level}</div>
                        <div style="font-size: 1.1em; color: #6c757d; margin-bottom: 10px;">
                            ${levelDescriptions[level]}
                        </div>
                        <div class="level-stats">
                            <strong>${progress.mastered} / ${progress.total}</strong> questions mastered
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressBarClass}" style="width: ${progressPercentage}%">
                                <div class="progress-text">${progressPercentage}%</div>
                            </div>
                        </div>
                        <div class="level-details">
                            ${progress.total > 0 ? 
                                `Need 70%+ success rate on all questions` : 
                                'No questions available yet'
                            }
                            ${clickHint}
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // Find the best question to start practicing for a given level
        function findBestQuestionForLevel(level) {
            const questionsInLevel = allQuestionsData[level] || [];
            if (questionsInLevel.length === 0) {
                console.log(`[DEBUG-2] üö´ No questions available for level ${level}`);
                return null;
            }

            // Get current user performance data
            const currentPerformanceData = currentData || [];
            
            // Count performance data specific to this level
            const performanceDataForLevel = questionsInLevel.filter(question => {
                return currentPerformanceData.find(p => p.questionId === question.id);
            }).length;
            
            console.log(`[DEBUG-2] üéØ Finding best question for level ${level}:`);
            console.log(`[DEBUG-2]    üìä Total questions in level: ${questionsInLevel.length}`);
            console.log(`[DEBUG-2]    üìà User has performance data for: ${performanceDataForLevel} questions in ${level} level (${currentPerformanceData.length} total across all levels)`);
            
            // Priority 1: Find questions never attempted
            const unattemptedQuestions = questionsInLevel.filter(question => {
                return !currentPerformanceData.find(p => p.questionId === question.id);
            });
            
            if (unattemptedQuestions.length > 0) {
                const selectedQuestionId = Math.min(...unattemptedQuestions.map(q => q.id));
                console.log(`[DEBUG-2] ‚ú® PRIORITY 1: Found ${unattemptedQuestions.length} unattempted questions`);
                console.log(`[DEBUG-2]    üé≤ Selected question ${selectedQuestionId} (lowest ID of unattempted)`);
                console.log(`[DEBUG-2]    üìù Reason: Student has never attempted this question - perfect for new learning`);
                return selectedQuestionId;
            }
            
            // Priority 2: Find questions with success rate below 70%
            const needsPracticeQuestions = questionsInLevel.filter(question => {
                const performance = currentPerformanceData.find(p => p.questionId === question.id);
                return performance && performance.successRate < 70;
            }).sort((a, b) => {
                // Sort by lowest success rate first, then by question ID
                const perfA = currentPerformanceData.find(p => p.questionId === a.id);
                const perfB = currentPerformanceData.find(p => p.questionId === b.id);
                const rateA = perfA ? perfA.successRate : 0;
                const rateB = perfB ? perfB.successRate : 0;
                
                if (rateA !== rateB) {
                    return rateA - rateB; // Lowest success rate first
                }
                return a.id - b.id; // Then by ID
            });
            
            if (needsPracticeQuestions.length > 0) {
                const selectedQuestion = needsPracticeQuestions[0];
                const performance = currentPerformanceData.find(p => p.questionId === selectedQuestion.id);
                console.log(`[DEBUG-2] üìà PRIORITY 2: Found ${needsPracticeQuestions.length} questions needing practice (<70% success)`);
                console.log(`[DEBUG-2]    üìâ Selected question ${selectedQuestion.id} with ${performance.successRate}% success rate`);
                console.log(`[DEBUG-2]    üí™ Reason: Student struggling with this question - targeted practice needed`);
                console.log(`[DEBUG-2]    üìã Attempts: ${performance.attempts}, Last tried: ${new Date(performance.lastAttempted).toLocaleDateString()}`);
                return selectedQuestion.id;
            }
            
            // Priority 3: If all questions are mastered, return the first question for review
            const selectedQuestionId = Math.min(...questionsInLevel.map(q => q.id));
            const masteredCount = questionsInLevel.filter(question => {
                const performance = currentPerformanceData.find(p => p.questionId === question.id);
                return performance && performance.successRate >= 70;
            }).length;
            
            console.log(`[DEBUG-2] üèÜ PRIORITY 3: All questions mastered or attempted with good success rates`);
            console.log(`[DEBUG-2]    ‚úÖ ${masteredCount}/${questionsInLevel.length} questions mastered (‚â•70% success)`);
            console.log(`[DEBUG-2]    üîÑ Selected question ${selectedQuestionId} (lowest ID) for review practice`);
            console.log(`[DEBUG-2]    üìö Reason: Maintaining mastery through spaced repetition`);
            
            return selectedQuestionId;
        }

        // Launch the quiz with a specific level and question
        function launchQuizWithLevel(level, questionId) {
            console.log(`[DEBUG-2] üöÄ Launching practice session for level ${level} with question ${questionId}`);
            
            // Create a nice visual feedback
            const levelCard = event.currentTarget;
            levelCard.style.transform = 'scale(0.95)';
            levelCard.style.opacity = '0.8';
            
            setTimeout(() => {
                // Show a brief notification
                const notification = document.createElement('div');
                notification.innerHTML = `üöÄ Launching ${level} practice session...`;
                notification.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 12px;
                    font-size: 1.2em;
                    font-weight: bold;
                    z-index: 1000;
                    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
                    text-align: center;
                `;
                document.body.appendChild(notification);
                
                console.log(`[DEBUG-2] üéØ Redirecting to main app: french_listening_app.html?start=${questionId}`);
                console.log(`[DEBUG-2] üìñ Student will start with an intelligently selected question for optimal learning`);
                
                setTimeout(() => {
                    // Navigate to the main app with the specific question
                    window.location.href = `french_listening_app.html?start=${questionId}`;
                }, 800);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 1500);
            }, 150);
        }

        function renderOverallProgressSummary(levelProgress) {
            const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            
            // Calculate overall statistics
            const completedLevels = levels.filter(level => levelProgress[level].isCompleted).length;
            const totalMasteredQuestions = levels.reduce((sum, level) => sum + levelProgress[level].mastered, 0);
            const totalQuestions = levels.reduce((sum, level) => sum + levelProgress[level].total, 0);
            const overallPercentage = totalQuestions > 0 ? Math.round((totalMasteredQuestions / totalQuestions) * 100) : 0;

            // Update summary display
            document.getElementById('totalLevelsCompleted').textContent = completedLevels;
            document.getElementById('totalQuestionsCompleted').textContent = totalMasteredQuestions;
            document.getElementById('overallProgressPercent').textContent = `${overallPercentage}%`;

            // Show the summary if there's any progress
            const summaryElement = document.getElementById('overallProgressSummary');
            if (totalMasteredQuestions > 0) {
                summaryElement.style.display = 'block';
            } else {
                summaryElement.style.display = 'none';
            }
        }

        // Collapsible container toggle function
        function toggleCollapsible(containerId) {
            const container = document.getElementById(containerId);
            container.classList.toggle('collapsed');
        }

        // Hamburger menu toggle logic
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const menuDropdown = document.getElementById('menuDropdown');
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        hamburgerBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            hamburgerMenu.classList.toggle('open');
        });
        document.addEventListener('click', function(e) {
            if (!hamburgerMenu.contains(e.target)) {
                hamburgerMenu.classList.remove('open');
            }
        });
    </script>
</body>
</html> 